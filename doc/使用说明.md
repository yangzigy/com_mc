<link rel="stylesheet" type="text/css" href="base.css">

通用测控上位机  
======
[toc]
## 功能概述
通用测控上位机软件的主要功能包括：
1. **多种数据源通信功能**
   软件可使用串口、udp、原始数据文件、带时间戳日志4种数据源，实现数据的读入；可使用串口、udp两种数据源实现指令下发。
   数据源在配置文件中配置基本参数，在软件运行时选用，可在运行时打开、关闭、更换数据源。
2. **可配置协议解析功能**
   软件可根据配置实现不同协议的解析，以适应不同项目、不同设备的数据接收，实现通用上位机功能。
   对各种测控场景下协议的适应程度需要与简便性、效率等因素进行权衡，软件支持的协议类型包括：
   1) 类NMEA的分行分列文本协议
   2) 二进制协议，能够在协议头部区分帧类型的定长包、能够在协议域中通过线性运算或映射的变长包
   3) 任意协议（插件实现）
3. **接收数据显示功能**
   软件可显示数据接收的字节流量，以确认当前的通信状态是否正常
   接收到的数据经可配置协议解析后形成参数，参数通过数值文本在界面上显示。
   界面上通过不同的颜色区分每一个参数在最近1秒内是否被更新过，用以指示通信是否发生。
4. **数据曲线测量功能**
   接收到的数据可以曲线的方式显示，曲线的颜色由系统自动生成，横坐标默认为时间，单位ms
   当显示时间无关的一系列数值曲线时，可指定坐标轴为某个参数，横坐标为点数。当此参数刷新时，横坐标加1，用以显示同一时刻的一系列数值曲线。注意此模式与按时间显示的曲线是互斥的两种模式，即，曲线区域只有一个，横纵坐标只有一组。
   曲线分析功能包括：
   1) 游标功能：显示鼠标所选位置处的横纵坐标值、各条曲线在此横坐标处的值
   2) 测距功能：显示两个点之间的横纵坐标间距
   3) 缩放功能：能够对曲线显示区域进行任意缩放
   4) 自适应显示功能：能够自适应坐标范围，显示所有数据
5. **可配置指令下发功能**
   可配置上位机的指令按钮，实现定制化的指令下发功能。按钮种类包括点动按钮、参数下发按钮、参数刷新按钮、带状态显示的开关等
   可配置指令只实现了点动模式和周期模式，即每次点击或周期进行下发，没有实现按逻辑下发、多指令轮询等功能，但可以通过插件扩展实现
6. **日志记录功能**
   软件可记录接收到的原始数据、带时间戳的文本数据、带时间戳的二进制日志，供事后分析
7. **历史数据回放功能**
   软件可打开记录的日志进行回放，日志类型包括：原始数据、带时间戳的文本数据、带时间戳的二进制日志
   通过数据源实现回放，回放的过程与直接的物理通信完全一致。
   回放是按时间戳进行的，同时具有倍速、指定位置、指定ms数等功能
8. **日志格式转换功能**
   软件可对记录日志、原始数据实现一定的格式转换功能，以方便日志回放和记录数据分析。格式转换功能包括：
   1) 回放数据导出成cmlog格式
   2) 回放数据导出原始数据
   3) 回放数据导出成ttlog格式
   4) 回放数据中将指定的参数导出成csv
   5) cmlog修改基准时间戳
   6) hex原始数据转二进制
   7) 二进制原始数据转文本
   8) 在文件中提取特定方阵数据
   9) 文件合并
   10) cmlog文件按时间戳合并
9.  **插件扩展功能**
   软件可通过C#的dll进行扩展，在插件中，可以访问程序中的所有变量，并在程序主体流程框架下进行功能扩展。
## 软件界面  
### 界面分区
界面包括1、菜单区、2、软件控制区、3、曲线显示区、4、传感量显示区、5、控制控件区

### 菜单区
菜单栏包括：文件、选项、工具、显示、参数、帮助，状态显示区
1. 文件菜单
“保存曲线”，“加载曲线”，对当前显示的曲线进行保存和加载，使用csv格式存储
“加载指定配置”，弹出文件选择框，实现配置文件的动态加载。
菜单下半部分，为软件根目录配置的几种常用配置，方便选择。常用配置可放置在任意路径下，通过exe同目录的cm_cfgs.txt文件描述
2. 选项菜单
   记录设置：可选择记录的文件为：原始数据 .org，带时间戳文本 .ttlog，带时间戳二进制 .cmlog
   若协议为二进制，选择带时间戳文本，则不记录；若协议为文本，选择带时间戳二进制，则文本部分记录到cmlog的0信道。
3. 工具菜单
4. 显示菜单
   适应屏幕：使曲线显示区域适应所有曲线点的范围
   回放对话框：
   协议编辑器：
5. 参数菜单
6. 帮助菜单
### 软件控制区
### 曲线显示区
### 传感量显示区
传感量的显示包括值和刷新两部分，对于每个传感量，通过配置描述，指明其协议，以及解析方法  
传感量通过一个checkbox显示，粉色代表无刷新，绿色有刷新，打勾为显示曲线  
传感量分为显示和不显示两种，需要显示的传感量在界面上显示，不需要显示的传感量是用于控制控件显示的，不再传感量显示区显示。
### 控制控件区
根据不同的控制变量，可以设置不同的控制按钮形式，以控件的方式实现配置，支持的控制控件包括：  
1. bt: 按键，单击发送指令，可配置引用文本框或参数编辑框作为指令的参数  
1. text: 文本框，为用户提供输入区域  
1. sw: 开关，可实现下发“开”“关”指令，同时显示当前传感量的状态是开是关  
1. rpl_bool: 带回复的指令，单击下发指令，在1s内收到回复，则高亮表示有反应。颜色表示回复的正确性  
1. label: 文本控件，可显示一个固定字符，或者空白，为布局填充  
1. para: 参数编辑框，带有刷新标志，点击刷新标志下发刷新指令，1s内回复，则刷新标志变绿  

## 通信协议
### 通用文本行协议
使用类nmea协议的形式，作为上位机的标准协议，其他协议使用适配器来适配。例如，下位机使用二进制协议时，上位机通过C语言dll外扩适配器，将文本协议转换为二进制协议与下位机交互。所以，上位机只需实现通用文本协议即可实现所有测控协议需求。  
协议规定：  
> - 数据由文本组成，文本分行，行分列。  
> - 每一行数据可以是不同的数据包类型，通过列数量或第一列文本决定数据包类型  
> - 使用行（\n）作为数据包的分割，对于指令，使用空格或tab作为参数的分割符。对于测量变量，使用空格、逗号、tab作为分隔符  
> - 行首第一列可以作为普通数据，也可作为协议标志，以$开头，接接协议名称。  
例如：  
```  
    1 2 3 4 5 6 7      是一个7列数据，若系统中没有其他数据包是7列，则可以通过列数唯一确定这个数据包类型
    $r,OK              是一个2列数据，第一列以$开头，则“r”为协议名称，通过“r”确定这个数据包的类型
```  
规定：  
指令配置时，可通过写入\n来做多个指令  
'$'开头的是与插件或下位机约定的文本协议  
'^'开头的是软件自身控制协议：  
- ^clear         清除当前数据  
- ^x_axis 总电压 x轴的索引，只有收到此变量后才增加曲线x轴坐标，若为空，则使用时间ms数作为x轴  
### 二进制协议

## 配置方法  
### 项目配置文件组织  
软件在exe目录寻找cm_cfgs.txt，列出多个项目的配置。此文件可没有  
软件在exe目录寻找默认配置config.txt，作为第一个加载的配置。此文件可没有  
软件需上述两个文件之一，作为默认加载的配置  
![image](draft/配置结构.png)  
### 指令配置协议  
指令名称要求没有空格,可配置的域包括：  

### 测量变量配置协议  
变量名称要求没有空格,可配置的域包括：  

### 数据源配置  
### 软件配置  
### 协议配置  
参考《配置设计》文档  
使用协议编辑对话框可以查看协议的具体信息，并编辑协议内容，但相比文本编辑器，通过简易的图形界面进行编辑并不方便。当前图形界面仅便于对协议查看。
## 功能操作
### 显示设备上行数据
### 数据保存
### 对设备进行控制
### 回放存储的数据
### 对日志进行格式转换
日志数据格式转换功能包括一系列转换工具
#### 导出成cmlog格式

#### 导出原始数据
将当前选中的数据导出成原始数据。在回放对话框中的导出菜单中实现。首先需要软件加载特定的协议配置，然后打开回放数据，然后选择导出原始数据功能，将所选择的数据（指定虚拟信道、指定帧范围）去掉头部时间戳，仅保留原始数据部分，保存为文件。
#### 导出成ttlog格式
#### 将指定的参数导出成csv
#### cmlog修改基准时间戳
#### hex原始数据转二进制
#### 二进制原始数据转文本
#### 在文件中提取特定方阵数据
#### 文件合并
在工具菜单中，点击文件合并工具。
弹出2次文件选择器，实现2个文件的直接合并功能。
#### cmlog文件按时间戳合并

### 显示非时间序列的曲线
## 案例  
项目中的案例（sample目录下）： 
| 文件名 | 内容 |  
| -- | -- | 
| cm_cfgs.txt | 配置列表 |  
| config.txt | 默认配置，通过一个主配置文件实现所有配置，仅包含文本协议，协议内容为s0_text |  
| sample/s0_text | 最简案例：纯文本协议, 详见案例说明  |  
| sample/s1_bin_mul_prot | 二进制多协议域案例，详见案例说明 |  
| sample/s2_datatest | 数据格式转换测试用例，详见案例说明 |  
| sample/s3_bin_text | 二进制文本混合协议，详见案例说明 |  

