<link rel="stylesheet" type="text/css" href="base.css">

配置设计  
======  
## 配置文件设计  
### 配置文件组织
配置文件需要配置的内容包括：
- 软件设置：窗口大小等
- 数据源
- 指令
- 配套插件地址
- 帧同步配置
- 协议配置
  - 参数列表
  - 协议配置

软件启动时默认加载config.txt，可以通过指定额外的配置文件，减少主配置文件的行数，并使协议能够独立配置。加载配置时，是将主配置文件中的信息向后加载的配置json串中更新，所以主配置文件优先级最高，额外配置文件中先加载的优先级高，后加载的被覆盖。

软件可动态加载多个项目的配置和插件，所以在exe同目录下可以通过cm_cfgs.txt文件，描述可选的配置。配置文件结构  
![image](draft/配置结构.png)  
配置文件的列表：
| 文件 | 位置 |  功能 | 
| - | - | - | 
| cm_cfgs.txt | exe同目录 | 用于索引多个软件配置文件，**非必选** |
| config.txt | exe同目录 | 作为默认的软件配置文件，可存储软件和协议的所有配置，也可指定额外配置文件，对协议进行额外配置。**非必选**，与cm_cfgs.txt必选其一 |
| 任意名.cmd | 任意目录 | 额外配置文件，可取任意名，任意扩展名。存储指令配置部分 |
| 任意名.para | 任意目录 | 额外配置文件，可取任意名，任意扩展名。存储测量值配置部分 |
| 任意名.prot | 任意目录 | 额外配置文件，可取任意名，任意扩展名。存储协议结构配置部分 |
| 任意名.cfg | 任意目录 | 额外配置文件，可取任意名，任意扩展名。存储软件配置部分 |
### 配置读取流程
初始化时，首先清除上次配置。初始化测控体系结构，然后根据测控对象（MC_Prot : mc_prot）中的参数字典（ParaValue : para_dict），初始化界面参数显示字典（DataDes : dset）
## 配置文件格式
### cm_cfgs.txt
### 软件配置部分
### 指令配置部分
### 协议配置部分
#### 参数配置
para_dict: 参数列表
参数配置json串中，主要是对动态协议的测量量ParaValue进行配置，由协议编辑对话框保存的配置也只有对ParaValue的配置。但通用上位机需要对每个测量量进行额外配置，包括是否显示、是否默认显示曲线等。
可以通过多个配置文件的配置实现额外配置：在动态协议配置文件中仅配置ParaValue，而在通用上位机主配置文件中，对para_dict实施增量配置，添加额外配置。
#### 协议配置
struct_dict: 协议域结构字典
prot_roots: 二进制根节点列表，引用struct_dict中的协议域，若没有说明没有二进制协议
tl_root: 文本协议根字典，是一个PD_LineSwitch对象，引用struct_dict中的协议域，若没有说明没有文本协议
### 文本协议列表:textline_dict  
文本协议列表为一个数组，内容为协议（PD_LineObj）  
协议对象的配置包括：  
1. id：参数的唯一id，可不指定  
1. name：协议域名称,这里表示协议文本行第一列指定数据类型的字符串(唯一，或没有)  
1. col_n：此协议的列数，必填  
1. type：DataType类型  
1. ref_name：引用参数的名称  
1. split_char_list：本协议的特殊分隔符  
若此文本行的分隔符特殊，可配置split_char_list修改，但col_n只能按默认分隔符分割出来的列数来填  
### 二进制协议根:prot_root  
### 帧同步配置
syn_pro: 帧同步配置json，在state_dis.cs : mc_ini函数中:(插件初始化)
	commc.pro_obj.fromJson(Config.config.syn_pro); //帧同步部分初始化
若配置了syn_line，或没有配置，则给Sync_Line对象，用文本帧同步
二进制的无需配置帧同步，用的是增量协议校验

