动态协议设计  
======  
# 动态协议需求  
针对MCU测控应用场景，软硬件往往是通用的，而不是针对某一项目定制的。例如，PLC、canopen的测控模块等。这些设备的组合形成不同的测控系统  
> - 对于一个系统，可能由多种配置方法，可以使用不同的设备实现同一参数的测控。这样就造成同一个参数有多种协议传输  
> - 配置变更后，系统的二进制历史数据就只有老的程序才能打开，经过多次变更、软件升级后，历史数据基本无法使用了  
针对此需求，可使用动态协议配置的方式满足。  
1. 动态协议配置是将测控所需的参数放在“参数数据库”中（例如canopen的对象字典，modbus的寄存器），测控逻辑在数据库中操作，协议对数据库进行读写，实现逻辑与协议分离。  
2. 通过协议的动态配置，实现不修改代码，仅修改配置就适配不同的协议。  
![image](draft/动态协议框架.png)  
动态协议的局限性：  
- 由于当前动态协议域的名称是局部名称，所以所有协议都必须在同一个根节点下定义。只有生成全局名称，才能实现协议的分批加载  
- 由于当前动态协议组织的参数引用只支持简单运算，所以不能支持复杂的变长包定义。只有建立符号系统，定义协议中各项参数的宏，才能实现任意变长包的解析  

总之，动态协议仅满足一般较规律的协议定义，特定协议的支持还是需要以控件的形式实现。与其建立复杂的动态协议机制，不如通过一小段程序方便  
# 动态协议概念设计  
## 参数  
参数是协议中承载的变量，可被，类型包括：  
1. 数值：例如整数、浮点数  
2. 数组：例如字符串、二进制序列  
特殊的，当参数用于显示时，可以分为几类：  
1. 数组型，按字符串显示  
1. 数组型，未知格式，按hex显示  
1. 数值型，按配置的小数位数显示  
1. 数值型，按枚举字符串显示  
参数对于逻辑程序来说，可以使用指针访问，因为逻辑程序一定知道参数的类型。总结来说，可以按以上2类作为参数类的子类设计（数值、数组），并加入参数具体描述显示方式  
程序定义：  
数组类型的参数：ParaValue_Str  
数值类型的参数：ParaValue_Val  
对于用户来说，参数的全部类型包括：  
```  
public enum ParaType //参数类型
{
	u8, u16, u32, u64, //无符号整数
	s8, s16, s32, s64, //有符号整数
	f, df, //float、double
	undef, str, //未定义、字符串
}
```  
## 协议  
协议包括3部分：数据的帧同步、数据帧中各域的拆分、数据域树形结构的叶子节点处理。协议域通过唯一字符名称来索引  
![image](draft/动态协议过程.png)  
### 数据帧同步  
数据可通过同步头+校验的方式从数据流中确定一个数据帧的范围，例如二进制协议中通过包头、校验和的方式进行传输  
数据可通过帧尾同步的方式提取数据，例如文本行协议中，通过分行符和分列符实现数据分割。  
帧同步可首先实现一个通用版，通过配置实现大多数协议的同步，然后通过插件的方式实现特定协议的同步  
### 数据域拆分  
一个协议以树形结构划分各域，数据域的组织形式可以分为几种：  
1. obj：协议对象，一组顺序排列的协议域，只需记录子协议名称即可  
2. switch：选择节点，协议中的此域可以是不同的子协议，由选择节点确定具体是哪个子协议  
3. loop：重复域，表示此处有重复的对象，对象类型不必相同，对象个数可以指定  

协议树的组织根据这些对象关联的叶子节点的值来确定，例如，选择节点，引用协议中的类型数据，根据类型数值选择不同的协议；重复域，根据数据包中的某个数据，来确定重复次数。  
但是由于对象的引用只有一个，运算规则仅有线性运算，所以像modbus那样的协议就难以实现。除非做符号系统，实现更多的运算规则。  
对于复杂运算，还是用插件实现比较好。动态协议配置仅实现规则简单的协议。  
### 叶子节点  
不同的数据域组织形式都只定义协议的树形结构，只有叶子节点是实体。  
叶子节点指明此数据域的输出参数索引，从协议中读数后，做相应的变换后再输出给参数。叶子节点可不指定输出参数，仅做占位  
协议中数据输入的类型包括：  
1. 二进制值类型：只需指定具体类型，即可取得值，并根据变换得到输出类型的值  
2. bit类型：影响在协议中的偏移增量，处理可按值类型处理  
3. 数组类型：包括字符串和未定义类型，可直接复制给输出参数  
4. 文本类型：需要从文本中提取值  
叶子节点可分为值、数组型2个子类，用具体类型区分处理。   
叶子节点根据输入类型和输出类型进行解析：  
> - 输入undef、字符串 输出是undef或者str 直接set_val的二进制接口  
> - 输入是字符串（10进制或hex） 输出是值 处理成double后变换，然后根据输出类型，构造对应的二进制数，若有浮点变整型，需要四舍五入，通过set_val二进制接口传出  
> - 输入二进制值 处理成对应的类型后变换，然后根据输出类型，构造对应的二进制数，若有浮点变整型，需要四舍五入，通过set_val二进制接口传出  
> - 输入是bit 处理成整数后变换，然后根据输出类型，构造对应的二进制数，若有浮点变整型，需要四舍五入，通过set_val二进制接口传出  
## 实现  
测控体系实现由MC_Prot类组织，包含了：参数字典、二进制协议根对象、文本行协议字典 共3部分数据  
MC_Prot类负责初始化整个体系，接受数据输入  
