<link rel="stylesheet" type="text/css" href="base.css">

3协议编辑界面设计
====== 
[TOC]
## 界面功能设计
协议编辑界面负责展示协议配置，方便协议配置的编写、调试。界面展示包括：
1. 协议族根节点列表: 展示所有根节点，添加、删除、选择
2. 文本协议列表: 展示所有文本协议，添加、删除、选择
3. 协议树：以定制化的树状控件展示协议的配置，二进制协议的字节长度
4. 参数列表：展示配置中的所有参数，添加、删除、选择
5. 对象属性：显示当前选中的对象，包括协议域、参数
6. 协议的打开和保存：通过菜单栏实现协议编辑操作
7. 协议测试：通过hex字符串测试协议
## 基础结构
动态协议的可视化通过一个对话框实现，对话框中通过DataGrid显示参数列表、协议列表、协议域根节点列表。并通过一个winform控件PropertyGrid实现具体对象的信息显示和编辑。

根节点列表、文本协议列表，参数列表，协议树控件的数据源均为==PEdit_Display==（带父指针的多子树），此类通过create_recu函数递归建立数据结构。引用的变量包括：
1. 子节点列表，用于树形结构记录
2. 上级节点，用于引用上级的子节点，进行结构操作
3. 属性显示对象（ProtDom_PropDis）：用于在属性区域显示。

为了显示具体对象的属性描述，UI部分对动态协议部分类进行了装饰，建立继承路径一致的显示协议接口：==Prop_Edit==，接口中定义display_2_var函数，用于从属性显示控件中刷新回到后台变量。分为参数和协议两部分，互不关联的定义。
Prop_Edit及其子类没有树形结构，定义父指针仅用于显示和刷新后台时查找名称

## 参数显示
由于参数不具有嵌套，结构简单，所以装饰类直接创建参数实体，进行显示。
## 协议结构显示
协议结构显示需要与配置文件中的协议结构配置相匹配，所以不能按实体来显示。由于具有嵌套结构，所以通过定义协议域的影子类，实现所有协议域类结构的显示定义，称为结构描述对象。

按结构描述对象显示需要解决几个问题：
1. **结构的长度计算**：可以在结构实例化的时候计算完成后，将len域补充到结构描述中。当加载结构显示时，就能读取到了
2. **嵌套对象的索引**：若是引用对象，则显示编辑时仅编辑字符串即可，这个字符串是相对路径引用的。若是嵌套协议域，是通过全局结构字典引用的，只需在结构字典里找即可。

结构的属性显示类中，具有的变量：
1. 嵌套定义结构的各种属性
2. 结构描述缓存：记录json字典的配置，采用引用的方式，在这里改动会直接影响协议配置数据

## 处理流程
### 配置读入
配置读入首先是在MainWindow.xaml.cs文件中的ini_by_config函数，从配置文件初始化程序，输入配置文件名
在ini_by_config函数中首先按json读取配置文件，加载额外配置，更新到json缓存中。并通过反序列化构造config对象
然后清除上一个配置
然后开始配置，调用state_dis.cs中的mc_ini函数，测控界面初始化
mc_ini函数中首先去除初始化，然后初始化
1. 测控后台初始化
	commc.ini(Config.cfg_dict); 
	其中：
	mc_prot.fromJson(v); //初始化动态协议部分
	将参数列表mc_prot.para_dict_out复制到显示参数表dset
	在配置para_dict中重新解析参数字典的配置(之前是通用动态协议库解的，显示部分不解)，拿出显示的配置
2. 初始化插件
3. 配置初始化指令
	ctrl_cmd，查看是否是控制指令
4. 传感参数部分
	从commc.dset中读取所有传感参数，加入界面显示，构造曲线，注册回调
5. 指令ui初始化
	从Config.config.cmds中读取指令，动态加载到显示界面
6. 菜单指令初始化
	从Config.config.menu_cmd中读取菜单指令，加入菜单
### 结果导出
### 属性修改
### 结构增删
