通用测控上位机  
======
## 软件操作  
### 界面
#### 传感量  
传感量的显示包括值和刷新两部分，对于每个传感量，通过配置描述，指明其协议，以及解析方法  
传感量通过一个checkbox显示，粉色代表无刷新，绿色有刷新，打勾为显示曲线  
#### 控制控件  
根据不同的控制变量，可以设置不同的控制按钮形式，以控件的方式实现配置，支持的控制控件包括：  
1. bt: 按键，单击发送指令，可配置引用文本框或参数编辑框作为指令的参数  
1. text: 文本框，为用户提供输入区域  
1. sw: 开关，可实现下发“开”“关”指令，同时显示当前传感量的状态是开是关  
1. rpl_bool: 带回复的指令，单击下发指令，在1s内收到回复，则高亮表示有反应。颜色表示回复的正确性  
1. label: 文本控件，可显示一个固定字符，或者空白，为布局填充  
1. para: 参数编辑框，带有刷新标志，点击刷新标志下发刷新指令，1s内回复，则刷新标志变绿  
### 曲线  
### 日志记录与回放  

## 通信协议
### 通用文本行协议
使用类nmea协议的形式，作为上位机的标准协议，其他协议使用适配器来适配。例如，下位机使用二进制协议时，上位机通过C语言dll外扩适配器，将文本协议转换为二进制协议与下位机交互。所以，上位机只需实现通用文本协议即可实现所有测控协议需求。  
协议规定：  
> - 数据由文本组成，文本分行，行分列。  
> - 每一行数据可以是不同的数据包类型，通过列数量或第一列文本决定数据包类型  
> - 使用行（\n）作为数据包的分割，对于指令，使用空格或tab作为参数的分割符。对于测量变量，使用空格、逗号、tab作为分隔符  
> - 行首第一列可以作为普通数据，也可作为协议标志，以$开头，接接协议名称。  
例如：  
```  
    1 2 3 4 5 6 7      是一个7列数据，若系统中没有其他数据包是7列，则可以通过列数唯一确定这个数据包类型
    $r,OK              是一个2列数据，第一列以$开头，则“r”为协议名称，通过“r”确定这个数据包的类型
```  
规定：  
指令配置时，可通过写入\n来做多个指令  
'$'开头的是与插件或下位机约定的文本协议  
'^'开头的是软件自身控制协议：  
- ^clear         清除当前数据  
- ^x_axis 总电压 x轴的索引，只有收到此变量后才增加曲线x轴坐标，若为空，则使用时间ms数作为x轴  
### 二进制协议

## 配置方法  
### 项目配置文件组织  
软件在exe目录寻找cm_cfgs.txt，列出多个项目的配置。此文件可没有  
软件在exe目录寻找默认配置config.txt，作为第一个加载的配置。此文件可没有  
软件需上述两个文件之一，作为默认加载的配置  
![image](draft/配置结构.png)  
### 指令配置协议  
指令名称要求没有空格,可配置的域包括：  

### 测量变量配置协议  
变量名称要求没有空格,可配置的域包括：  

### 数据源配置  
### 软件配置  
### 协议配置  
参考《配置设计》文档  
使用协议编辑对话框可以查看协议的具体信息，并编辑协议内容，但相比文本编辑器，通过简易的图形界面进行编辑并不方便。当前图形界面仅便于对协议查看。
## 案例  
项目中的案例（out目录下）： 
| 文件名 | 内容 |  
| -- | -- | 
| cm_cfgs.txt | 配置列表 |  
| config.txt | 默认配置，通过一个主配置文件实现所有配置，仅包含文本协议 |  
| cfgs/sample1_main.txt | 二进制与文本行混合协议的主配置文件 |  
| cfgs/sample1_para.txt | 协议中的参数描述 |  
| cfgs/sample1_prot.txt | 协议描述 |  
| data/2021-12-09_21.txt | 带时间戳文本行协议的案例数据（可回放） |  
| data/20220316_145350.dat | 带时间戳二进制协议的案例数据（可回放）已删除 |  
| data/20230126_091901.cmlog | cmlog格式混合协议的案例数据（可回放）含有文本和二进制两种数据 |  
| data/原始数据.txt | 文本的不带时间戳原始数据 |  
### 最简应用  
使用out/config.txt作为配置描述，项目采用文本行协议，设备信息通过多行文本上传，上位机指令通过文本行下发。  
上传协议（共8列）：  
| 0 | 1  | 2 | 3 | 4 | 5 | 6 | 7 |
| -- | --  | -- | -- | -- | -- | -- | -- |  
| 电压 | 空 | 电流 | 强度 | 期望温度 | 温度 | 空 | 状态字 |  
| 30.5 | 518 | 0.3 | 0.0 | 24.6 | 24.57 | 315.07 | 208DB9 |  
其中状态字为hex字符，表示一个4字节整数:  
第9~10bit代表工作模式，
第6bit代表调制输出  
第15bit代表温控  
参数协议（共2列）：  
| 参数 | 0列 | 1列  |  
| -- | --  | -- |  
| 指令结果 | $r | err或OK |  
| 电流偏置 | $@:3:1:0:16 | 数值 |  
#### 协议配置  
#### 开关、指令、参数控件  
#### 菜单参数、数据变换  
#### udp数据曲线分析  
配置网络端口：  
```json
{
	"type":"udp", //数据源类型：udp
	"name":"udp1",
	"ip" : "127.0.0.1", "port" : 12345,
	"rmt_ip" : "127.0.0.1", "rmt_port" : 12346
}
```  
### 二进制协议配置  
使用cfgs/cfg_bin.txt作为配置描述，参数与最简应用一致，定义二进制协议，传输这些参数。  
二进制数据包分为2种类型：  
1. 状态包（共20Byte）：  

| 位置 | 长度 | 参数 |  
| -- | --  | -- |  
| 0 | 1B | 同步字0xaa |  
| 1 | 1B | 类型：1：状态包 |  
| 2 | 2B | 电压：单位0.1 |  
| 4 | 2B | 空 |  
| 6 | 2B | 电流：单位0.1 |  
| 8 | 2B | 强度：单位0.1 |  
| 10 | 2B | 期望温度：单位0.1 |  
| 12 | 2B | 温度：单位0.1 |  
| 14 | 1B | 空 |  
| 15 | 3B | 状态字 |  
| 18 | 2B | crc |  
2. 参数包（共9Byte）：  

| 位置 | 长度 | 参数 |  
| -- | --  | -- |  
| 0 | 1B | 同步字0xaa |  
| 1 | 1B | 类型：2：参数包 |  
| 2 | 2~3B | 参数结构 |  
|  | 2~3B | 参数结构 |  
| 7 | 2B | crc |  
此包中包含2个参数结构，其中参数结构有两种：  
- 指令回复，第一字节为0x01，第二字节为回复值，0失败1成功  
- 电流偏置，第一字节为0x02，第二、三字节为电流值，单位0.1  

这两种结构先后顺序不做规定，但数据包中一定有这两种结构  
示例数据：  
1. 状态包  
aa 01 00 ff 00 00 20 00 10 00 f0 00 00 01 00 b9 8d 20 7b c5  
2. 参数包  
aa 02 01 00 02 80 00 a8 62  
aa 02 02 45 00 01 01 4b 08  
#### 二进制与文本混合  
对于同步字头字节大于127的情况，可利用二进制帧同步的失锁回调，兼容文本协议。也就是在数据流中，二进制包与文本行混合，通过帧同步程序解析出各自的协议。  
### 传感数据  

### 指令  

### 数据  

