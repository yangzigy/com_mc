通用测控上位机  
======
## 软件操作  
### 界面分区
### 传感量  
传感量的显示包括值和刷新两部分，对于每个传感量，通过配置描述，指明其协议，以及解析方法  
传感量通过一个checkbox显示，粉色代表无刷新，绿色有刷新，打勾为显示曲线  
传感量分为显示和不显示两种，需要显示的传感量在界面上显示，不需要显示的传感量是用于控制控件显示的，不再传感量显示区显示。
### 控制控件  
根据不同的控制变量，可以设置不同的控制按钮形式，以控件的方式实现配置，支持的控制控件包括：  
1. bt: 按键，单击发送指令，可配置引用文本框或参数编辑框作为指令的参数  
1. text: 文本框，为用户提供输入区域  
1. sw: 开关，可实现下发“开”“关”指令，同时显示当前传感量的状态是开是关  
1. rpl_bool: 带回复的指令，单击下发指令，在1s内收到回复，则高亮表示有反应。颜色表示回复的正确性  
1. label: 文本控件，可显示一个固定字符，或者空白，为布局填充  
1. para: 参数编辑框，带有刷新标志，点击刷新标志下发刷新指令，1s内回复，则刷新标志变绿  
### 菜单区
菜单栏包括：文件、选项、工具、显示、参数、帮助，状态显示区，以及数据源控制部分
#### 菜单
1. 文件菜单
可对当前显示的曲线进行保存和加载。
可实现配置文件的动态加载。

#### 数据源控制
### 曲线  
### 日志记录与回放  

## 通信协议
### 通用文本行协议
使用类nmea协议的形式，作为上位机的标准协议，其他协议使用适配器来适配。例如，下位机使用二进制协议时，上位机通过C语言dll外扩适配器，将文本协议转换为二进制协议与下位机交互。所以，上位机只需实现通用文本协议即可实现所有测控协议需求。  
协议规定：  
> - 数据由文本组成，文本分行，行分列。  
> - 每一行数据可以是不同的数据包类型，通过列数量或第一列文本决定数据包类型  
> - 使用行（\n）作为数据包的分割，对于指令，使用空格或tab作为参数的分割符。对于测量变量，使用空格、逗号、tab作为分隔符  
> - 行首第一列可以作为普通数据，也可作为协议标志，以$开头，接接协议名称。  
例如：  
```  
    1 2 3 4 5 6 7      是一个7列数据，若系统中没有其他数据包是7列，则可以通过列数唯一确定这个数据包类型
    $r,OK              是一个2列数据，第一列以$开头，则“r”为协议名称，通过“r”确定这个数据包的类型
```  
规定：  
指令配置时，可通过写入\n来做多个指令  
'$'开头的是与插件或下位机约定的文本协议  
'^'开头的是软件自身控制协议：  
- ^clear         清除当前数据  
- ^x_axis 总电压 x轴的索引，只有收到此变量后才增加曲线x轴坐标，若为空，则使用时间ms数作为x轴  
### 二进制协议

## 配置方法  
### 项目配置文件组织  
软件在exe目录寻找cm_cfgs.txt，列出多个项目的配置。此文件可没有  
软件在exe目录寻找默认配置config.txt，作为第一个加载的配置。此文件可没有  
软件需上述两个文件之一，作为默认加载的配置  
![image](draft/配置结构.png)  
### 指令配置协议  
指令名称要求没有空格,可配置的域包括：  

### 测量变量配置协议  
变量名称要求没有空格,可配置的域包括：  

### 数据源配置  
### 软件配置  
### 协议配置  
参考《配置设计》文档  
使用协议编辑对话框可以查看协议的具体信息，并编辑协议内容，但相比文本编辑器，通过简易的图形界面进行编辑并不方便。当前图形界面仅便于对协议查看。
## 功能操作
### 显示设备上行数据
### 数据保存
### 对设备进行控制
### 回放存储的数据
### 对日志进行格式转换
### 显示非时间序列的曲线
## 案例  
项目中的案例（sample目录下）： 
| 文件名 | 内容 |  
| -- | -- | 
| cm_cfgs.txt | 配置列表 |  
| config.txt | 默认配置，通过一个主配置文件实现所有配置，仅包含文本协议 |  
| sample/s0_text | 最简案例：纯文本协议, 详见案例说明  |  
| sample/s1_bin_mul_prot | 二进制多协议域案例，详见案例说明 |  

